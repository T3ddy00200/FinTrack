<UserControl x:Class="FinTrack.Controls.MessagesPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Background="{DynamicResource BackgroundBrush}"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch">

    <Grid Margin="0" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Верхняя панель: Ручная отправка уведомлений -->
        <Expander Header="Ручная отправка уведомлений"
                  ExpandDirection="Down"
                  Margin="20,10"
                  Foreground="{DynamicResource TextBrush}"
                  Background="{DynamicResource PanelBackgroundBrush}"
                  FontWeight="Bold"
                  FontSize="16" 
                  HorizontalAlignment="Stretch" IsExpanded="True">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="10" HorizontalAlignment="Stretch">
                    <TextBlock Text="Текст уведомления:"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,10">
                        <Button Content="Вставить имя {Name}"
                Click="InsertNameTag_Manual_Click"
                Margin="0,0,10,0"
                Background="{DynamicResource HoverBrush}"
                Foreground="{DynamicResource TextBrush}"/>
                        <Button Content="Вставить долг {Debt}"
                Click="InsertDebtTag_Manual_Click"
                Background="{DynamicResource HoverBrush}"
                Foreground="{DynamicResource TextBrush}"/>
                    </StackPanel>
                    <TextBox x:Name="MessageTextBox"
                             Height="80"
                             TextWrapping="Wrap"
                             AcceptsReturn="True"
                             Margin="0,5"  Background="{DynamicResource BorderBrush}" Foreground="{DynamicResource TextBrush}"
                             HorizontalAlignment="Stretch"/>
                    

                    <TextBlock Text="Выберите получателей:" Margin="10,10,0,5"/>
                    <ListBox x:Name="RecipientsListBox"
         Height="120"
         SelectionMode="Extended"
         HorizontalAlignment="Stretch"
                          Background="{DynamicResource BorderBrush}"     
         MouseDoubleClick="RecipientsListBox_MouseDoubleClick">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="0,2">
                                    <!-- Имя должника -->
                                    <TextBlock Text="{Binding Name}"
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource TextBrush}"/>
                                    <!-- Отступ -->
                                    <TextBlock Width="12"/>
                                    <!-- Статус PDF: имя файла или «(нет PDF)» -->
                                    <TextBlock Text="{Binding InvoiceFileName}"
                           Foreground="{DynamicResource SubTextBrush}"
                           FontStyle="Italic"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <DockPanel Margin="0,10,0,0" HorizontalAlignment="Center">
                        <Button x:Name="NotificationChoosePdfButton"
            Content="Выбрать PDF"
            Click="ChoosePdf_Click"
            Width="140"
            Background="{DynamicResource AccentBrush}"
            Foreground="White"
            BorderBrush="{x:Null}"/>
                        <TextBlock x:Name="NotificationPdfFileNameTextBlock"
               Text="(файл не выбран)"
               Margin="10,0,0,0"
               VerticalAlignment="Center"
               Foreground="{DynamicResource SubTextBrush}"/>
                    </DockPanel>

                    <Button Content="Отправить уведомление"
                            Click="SendNotification_Click"
                            Height="40"
                            Width="180"
                            Margin="0,10,0,0"
                            Background="{DynamicResource AccentBrush}"
                            Foreground="White"
                            BorderBrush="{x:Null}"
                            HorizontalAlignment="Center"
                            HorizontalContentAlignment="Center"/>
                </StackPanel>
            </ScrollViewer>
        </Expander>

        <!-- Основная часть: входящие письма и ответы -->
        <Grid Grid.Row="1" Margin="20" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <StackPanel Grid.Row="0" Margin="0,0,0,10" HorizontalAlignment="Stretch">
                <TextBlock Text="Входящие сообщения"
                           FontSize="24"
                           FontWeight="Bold"
                           Foreground="{DynamicResource TextBrush}" />
                <TextBlock x:Name="StatusTextBlock"
                           FontSize="14"
                           Foreground="{DynamicResource DangerBrush}"
                           Margin="0,5,0,0"/>
            </StackPanel>

            <ListBox x:Name="MessagesListBox"
                     Grid.Row="1"
                     Background="{DynamicResource PanelBackgroundBrush}"
                     Foreground="{DynamicResource TextBrush}"
                     BorderBrush="{DynamicResource BorderBrush}"
                     BorderThickness="1"
                     HorizontalAlignment="Stretch"
                     PreviewMouseWheel="MessagesListBox_PreviewMouseWheel"
                     VerticalAlignment="Stretch">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Padding="10" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                            <StackPanel>
                                <TextBlock Text="{Binding Subject}" FontWeight="Bold"/>
                                <TextBlock Text="{Binding From}" FontSize="12" Foreground="{DynamicResource SubTextBrush}"/>
                                <TextBlock Text="{Binding Preview}" FontSize="12" TextTrimming="CharacterEllipsis"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <Grid Grid.Row="2" Margin="0,20,0,0" HorizontalAlignment="Stretch">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBox x:Name="ReplyTextBox"
                         Grid.Row="0"
                         Height="80"
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         Background="{DynamicResource PanelBackgroundBrush}"
                         Foreground="{DynamicResource TextBrush}"
                         BorderBrush="{DynamicResource BorderBrush}"
                         BorderThickness="1"
                         HorizontalAlignment="Stretch"/>

                <DockPanel Grid.Row="1" Margin="0,5,0,5" HorizontalAlignment="Center">
                    <Button Content="Выбрать PDF"
                            Click="ChoosePdf_Click"
                            Width="120"
                            HorizontalAlignment="Center"
                            Background="{DynamicResource AccentBrush}"
                            Foreground="White"
                            BorderBrush="{x:Null}"/>
                    <TextBlock x:Name="ReplyPdfFileNameTextBlock"
                               Text="(файл не выбран)"
                               Margin="10,0,0,0"
                               VerticalAlignment="Center"
                               Foreground="{DynamicResource SubTextBrush}"/>
                </DockPanel>

                <Button Grid.Row="2"
                        Content="Ответить"
                        Click="ReplyButton_Click"
                        Width="140"
                        Height="40"
                        Background="{DynamicResource AccentBrush}"
                        Foreground="White"
                        BorderBrush="{x:Null}"
                        HorizontalAlignment="Center"
                        HorizontalContentAlignment="Center"/>
            </Grid>

            <!-- Прогресс бар -->
            <ProgressBar x:Name="ReplyProgressBar"
                         Grid.Row="3"
                         Height="10"
                         IsIndeterminate="True"
                         Visibility="Collapsed"
                         Margin="0,10,0,0"
                         Foreground="{DynamicResource AccentBrush}"/>
        </Grid>

        <!-- Экран загрузки — на весь UserControl -->
        <Border x:Name="LoadingOverlay"
                Grid.RowSpan="2"
                Background="#99000000"
                Visibility="Collapsed"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid>
                <TextBlock Text="Загрузка писем..."
                           Foreground="White"
                           FontSize="20"
                           FontWeight="Bold"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"/>
            </Grid>
        </Border>

        <!-- Экран отправки ответа — тоже на весь экран -->
        <Border x:Name="SendingOverlay"
                Grid.RowSpan="2"
                Background="#99000000"
                Visibility="Collapsed"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Grid>
                <TextBlock Text="Отправка ответа..."
                           Foreground="White"
                           FontSize="20"
                           FontWeight="Bold"
                           VerticalAlignment="Center"
                           HorizontalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
